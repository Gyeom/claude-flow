{
  "name": "Convention Auto-Fix",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 * * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Every Hour",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [120, 300],
      "notes": "ë§¤ì‹œê°„ Convention ê²€ì‚¬ ì‹¤í–‰"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "convention-scan",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [120, 480],
      "webhookId": "convention-scan-webhook",
      "notes": "POST /webhook/convention-scan { projectId?: string }"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/convention/enabled-projects",
        "options": {
          "timeout": 10000
        }
      },
      "id": "get-enabled-projects",
      "name": "Get Convention-Enabled Projects",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [360, 380],
      "notes": "CONVENTION.mdê°€ ìˆëŠ” í”„ë¡œì íŠ¸ ëª©ë¡ ì¡°íšŒ"
    },
    {
      "parameters": {
        "jsCode": "// ì›¹í›…ì—ì„œ íŠ¹ì • í”„ë¡œì íŠ¸ ì§€ì • ì‹œ í•„í„°ë§\nconst webhookData = $('Webhook Trigger').first()?.json;\nconst projects = $input.first().json;\n\nif (webhookData?.body?.projectId) {\n  // íŠ¹ì • í”„ë¡œì íŠ¸ë§Œ\n  const filtered = projects.filter(p => p.projectId === webhookData.body.projectId);\n  return filtered.map(p => ({ json: p }));\n} else {\n  // ëª¨ë“  í”„ë¡œì íŠ¸\n  return projects.map(p => ({ json: p }));\n}"
      },
      "id": "filter-projects",
      "name": "Filter Projects",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [560, 380],
      "notes": "ì›¹í›…ì—ì„œ projectId ì§€ì • ì‹œ í•´ë‹¹ í”„ë¡œì íŠ¸ë§Œ ì²˜ë¦¬"
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "loop-projects",
      "name": "Loop Projects",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [760, 380],
      "notes": "í”„ë¡œì íŠ¸ë³„ë¡œ ìˆœì°¨ ì²˜ë¦¬"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/convention/{{ $json.projectId }}/scan",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ scope: 'full' }) }}",
        "options": {
          "timeout": 300000
        }
      },
      "id": "scan-violations",
      "name": "Scan Violations",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [960, 380],
      "notes": "Convention ìœ„ë°˜ ìŠ¤ìº” (ìµœëŒ€ 5ë¶„)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-auto-fixable",
              "leftValue": "={{ $json.summary?.autoFixable }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-auto-fixable",
      "name": "Has Auto-Fixable?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1160, 380],
      "notes": "ìë™ ìˆ˜ì • ê°€ëŠ¥í•œ ìœ„ë°˜ì´ ìˆëŠ”ì§€ í™•ì¸"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/convention/{{ $json.projectId }}/fix",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ maxFixes: 5, createMr: true }) }}",
        "options": {
          "timeout": 600000
        }
      },
      "id": "fix-violations",
      "name": "Fix Violations",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1400, 300],
      "notes": "ìë™ ìˆ˜ì • ë° MR ìƒì„± (ìµœëŒ€ 10ë¶„)"
    },
    {
      "parameters": {
        "jsCode": "// ìŠ¤ìº” ê²°ê³¼ì™€ ìˆ˜ì • ê²°ê³¼ ë³‘í•©\nconst scanResult = $('Scan Violations').first().json;\nconst fixResult = $input.first().json;\n\nreturn [{\n  json: {\n    projectId: scanResult.projectId,\n    scanSuccess: scanResult.success,\n    summary: scanResult.summary,\n    fixSuccess: fixResult.success,\n    fixedCount: fixResult.fixedCount,\n    mrUrl: fixResult.mrUrl,\n    branchName: fixResult.branchName,\n    manualReviewNeeded: scanResult.summary.total - scanResult.summary.autoFixable\n  }\n}];"
      },
      "id": "merge-results",
      "name": "Merge Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1600, 300],
      "notes": "ìŠ¤ìº”/ìˆ˜ì • ê²°ê³¼ ë³‘í•©"
    },
    {
      "parameters": {
        "jsCode": "// ìë™ ìˆ˜ì • ì—†ì´ ìŠ¤ìº”ë§Œ ì™„ë£Œëœ ê²½ìš°\nconst scanResult = $('Scan Violations').first().json;\n\nreturn [{\n  json: {\n    projectId: scanResult.projectId,\n    scanSuccess: scanResult.success,\n    summary: scanResult.summary,\n    fixSuccess: null,\n    fixedCount: 0,\n    mrUrl: null,\n    branchName: null,\n    manualReviewNeeded: scanResult.summary.total\n  }\n}];"
      },
      "id": "scan-only-result",
      "name": "Scan Only Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1400, 480],
      "notes": "ìë™ ìˆ˜ì • ëŒ€ìƒ ì—†ì„ ë•Œ"
    },
    {
      "parameters": {
        "jsCode": "// ëª¨ë“  í”„ë¡œì íŠ¸ ê²°ê³¼ ìˆ˜ì§‘\nconst items = $input.all();\n\nconst results = items.map(item => item.json);\nconst totalFixed = results.reduce((sum, r) => sum + (r.fixedCount || 0), 0);\nconst totalManual = results.reduce((sum, r) => sum + (r.manualReviewNeeded || 0), 0);\nconst mrsCreated = results.filter(r => r.mrUrl).map(r => r.mrUrl);\n\nreturn [{\n  json: {\n    results,\n    summary: {\n      projectsScanned: results.length,\n      totalFixed,\n      totalManualReview: totalManual,\n      mrsCreated\n    }\n  }\n}];"
      },
      "id": "aggregate-results",
      "name": "Aggregate Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 380],
      "notes": "ì „ì²´ ê²°ê³¼ ì§‘ê³„"
    },
    {
      "parameters": {
        "resource": "message",
        "channel": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $env.SLACK_REVIEW_CHANNEL || 'general' }}"
        },
        "messageType": "block",
        "blocksUi": {
          "blocksValues": [
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "ğŸ”§ Convention Check ì™„ë£Œ"
              }
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "={{ 'ğŸ“Š *ê²€ì‚¬ ê²°ê³¼*\\n\\n' + '| êµ¬ë¶„ | ê°œìˆ˜ |\\n|------|------|\\n' + '| í”„ë¡œì íŠ¸ | ' + $json.summary.projectsScanned + ' |\\n' + '| âœ… ìë™ ìˆ˜ì • | ' + $json.summary.totalFixed + ' |\\n' + '| âš ï¸ ìˆ˜ë™ ê²€í†  | ' + $json.summary.totalManualReview + ' |' }}"
              }
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "={{ $json.summary.mrsCreated.length > 0 ? '\\nğŸ”— *ìƒì„±ëœ MR*\\n' + $json.summary.mrsCreated.map(url => 'â€¢ ' + url).join('\\n') : '\\n_ìë™ ìˆ˜ì •ëœ í•­ëª© ì—†ìŒ_' }}"
              }
            },
            {
              "type": "context",
              "elements": [
                {
                  "type": "mrkdwn",
                  "text": "ìˆ˜ë™ ê²€í† ê°€ í•„ìš”í•œ í•­ëª©ì€ ê° í”„ë¡œì íŠ¸ì˜ `CONVENTION_VIOLATIONS.md`ë¥¼ í™•ì¸í•˜ì„¸ìš”."
                }
              ]
            }
          ]
        }
      },
      "id": "send-slack-notification",
      "name": "Send Slack Notification",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [2000, 380],
      "credentials": {
        "slackApi": {
          "id": "slack-credentials",
          "name": "Slack API"
        }
      },
      "notes": "ê²°ê³¼ ìš”ì•½ì„ Slackìœ¼ë¡œ ì „ì†¡"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'Convention scan completed', summary: $json.summary }) }}",
        "options": {}
      },
      "id": "webhook-response",
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2200, 380],
      "notes": "ì›¹í›… ì‘ë‹µ ë°˜í™˜"
    }
  ],
  "connections": {
    "Every Hour": {
      "main": [
        [
          {
            "node": "Get Convention-Enabled Projects",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Get Convention-Enabled Projects",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Convention-Enabled Projects": {
      "main": [
        [
          {
            "node": "Filter Projects",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Projects": {
      "main": [
        [
          {
            "node": "Loop Projects",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Projects": {
      "main": [
        [
          {
            "node": "Scan Violations",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scan Violations": {
      "main": [
        [
          {
            "node": "Has Auto-Fixable?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Auto-Fixable?": {
      "main": [
        [
          {
            "node": "Fix Violations",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Scan Only Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Violations": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Results": {
      "main": [
        [
          {
            "node": "Loop Projects",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scan Only Result": {
      "main": [
        [
          {
            "node": "Loop Projects",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Results": {
      "main": [
        [
          {
            "node": "Send Slack Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Slack Notification": {
      "main": [
        [
          {
            "node": "Webhook Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "convention",
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z"
    },
    {
      "name": "auto-fix",
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z"
    }
  ],
  "triggerCount": 0,
  "active": false,
  "pinData": {},
  "versionId": "1"
}
