#!/bin/bash
# Pre-commit hook: 회사/도메인 특정 값 누출 방지
# 이 훅은 커밋 전에 민감한 하드코딩된 값들을 검사합니다.

set -e

# 색상 정의
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 검사할 패턴 목록 (정규식)
# 주의: 이 패턴들은 오픈소스 프로젝트에서 제외되어야 하는 회사 특정 값들입니다
SENSITIVE_PATTERNS=(
    # 회사명/도메인
    "42dot"
    "gitlab\\.42dot\\."

    # 내부 프로젝트명 (예시용으로 보이지 않는 것들)
    # "ccdc"  # Jira 프로젝트 키로 사용될 수 있으므로 주석처리
    # "ccds"  # 일반적인 약어일 수 있으므로 주석처리

    # 내부 그룹명
    "sirius/"
)

# 제외할 파일 패턴
EXCLUDE_PATTERNS=(
    "config/projects.json"  # 사용자 설정 파일
    ".git/"
    "node_modules/"
    "*.lock"
    "*.min.js"
    "*.min.css"
    ".claude/hooks/"  # Hook 파일 자체는 패턴 정의를 포함하므로 제외
)

# 스테이징된 파일 목록 가져오기
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

FOUND_ISSUES=0

for pattern in "${SENSITIVE_PATTERNS[@]}"; do
    # 각 스테이징된 파일 검사
    for file in $STAGED_FILES; do
        # 제외 패턴 확인
        SKIP=0
        for exclude in "${EXCLUDE_PATTERNS[@]}"; do
            if [[ "$file" == $exclude ]] || [[ "$file" == *"$exclude"* ]]; then
                SKIP=1
                break
            fi
        done

        if [ $SKIP -eq 1 ]; then
            continue
        fi

        # 바이너리 파일 건너뛰기
        if file "$file" | grep -q "binary"; then
            continue
        fi

        # 파일이 존재하는지 확인
        if [ ! -f "$file" ]; then
            continue
        fi

        # 패턴 검색 (대소문자 무시)
        MATCHES=$(grep -inE "$pattern" "$file" 2>/dev/null || true)

        if [ -n "$MATCHES" ]; then
            if [ $FOUND_ISSUES -eq 0 ]; then
                echo -e "${RED}========================================${NC}"
                echo -e "${RED}⚠️  민감한 정보 발견!${NC}"
                echo -e "${RED}========================================${NC}"
                echo ""
            fi

            echo -e "${YELLOW}패턴:${NC} $pattern"
            echo -e "${YELLOW}파일:${NC} $file"
            echo "$MATCHES" | while read -r line; do
                echo "  $line"
            done
            echo ""
            FOUND_ISSUES=1
        fi
    done
done

if [ $FOUND_ISSUES -eq 1 ]; then
    echo -e "${RED}========================================${NC}"
    echo -e "${RED}커밋이 차단되었습니다.${NC}"
    echo ""
    echo "위 파일들에서 회사/도메인 특정 값이 발견되었습니다."
    echo "오픈소스 프로젝트에서는 이런 값들을 일반화된 예시로 변경해야 합니다."
    echo ""
    echo "예시:"
    echo "  - gitlab.42dot.ai → gitlab.example.com"
    echo "  - CCDC-123 → PROJ-123"
    echo "  - sirius/ccds → team/project"
    echo ""
    echo "이 검사를 건너뛰려면 --no-verify 옵션을 사용하세요:"
    echo "  git commit --no-verify -m \"메시지\""
    echo -e "${RED}========================================${NC}"
    exit 1
fi

# ================================================================
# 2단계: Claude 기반 문서 자동 업데이트
# ================================================================
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOC_UPDATE_SCRIPT="$SCRIPT_DIR/doc-auto-update.sh"

if [ -x "$DOC_UPDATE_SCRIPT" ]; then
    "$DOC_UPDATE_SCRIPT"
fi

exit 0
