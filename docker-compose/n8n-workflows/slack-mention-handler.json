{
  "name": "Slack Mention Handler",
  "versionId": "mention-handler-v4",
  "meta": {
    "description": "SlackÏóêÏÑú @Î©òÏÖò Î©îÏãúÏßÄÎ•º Ï≤òÎ¶¨Ìï©ÎãàÎã§. ÏùºÎ∞ò ÏßàÎ¨∏, Î™ÖÎ†πÏñ¥(/health Îì±), MR Î¶¨Î∑∞ ÏöîÏ≤≠ÏùÑ Î∂ÑÎ•òÌïòÏó¨ Ï†ÅÏ†àÌïú Ìï∏Îì§Îü¨Î°ú ÎùºÏö∞ÌåÖÌï©ÎãàÎã§."
  },
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "slack-event",
        "responseMode": "onReceived",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "slack-event"
    },
    {
      "parameters": {
        "jsCode": "// Î©îÏãúÏßÄ Ïú†Ìòï Î∂ÑÎ•ò: command, mr-review, general, skip\nconst body = $input.item.json.body || {};\nconst eventType = body.eventType || '';\n\n// Î¶¨Ïï°ÏÖò Ïù¥Î≤§Ìä∏Îäî Ïä§ÌÇµ (ÌîºÎìúÎ∞± Ìï∏Îì§Îü¨ÏóêÏÑú Ï≤òÎ¶¨)\nif (eventType.includes('REACTION')) {\n  return { json: { ...body, messageType: 'skip', skipReason: 'reaction event' } };\n}\n\nconst text = (body.text || '').replace(/<@[A-Z0-9]+>/gi, '').trim();\n\n// Îπà ÌÖçÏä§Ìä∏Îäî Ïä§ÌÇµ\nif (!text) {\n  return { json: { ...body, messageType: 'skip', skipReason: 'empty text' } };\n}\n\n// Í∏∞Î≥∏ Í≤∞Í≥º Í∞ùÏ≤¥\nconst result = { ...body, messageType: 'general', isMrReview: false };\n\n// 1. Î™ÖÎ†πÏñ¥ Ï≤¥ÌÅ¨ (/Î°ú ÏãúÏûë)\nif (text.charAt(0) === '/') {\n  result.messageType = 'command';\n  return { json: result };\n}\n\n// 2. MR Î¶¨Î∑∞ ÏöîÏ≤≠ Ï≤¥ÌÅ¨\nconst mrPatterns = [\n  /!([0-9]+)/,\n  /MR\\s*#?([0-9]+)/i,\n  /merge_requests?\\/([0-9]+)/i\n];\n\n// ÌîÑÎ°úÏ†ùÌä∏ ÌûåÌä∏ Ï∂îÏ∂ú\nconst projectPatterns = [\n  /\\[ÌîÑÎ°úÏ†ùÌä∏:\\s*([^\\]]+)\\]/i,\n  /([a-z][a-z0-9-]*-server)/i,\n  /([a-z][a-z0-9-]+)\\s+!\\d+/i\n];\n\nlet projectHint = null;\nfor (const pattern of projectPatterns) {\n  const match = text.match(pattern);\n  if (match) {\n    projectHint = match[1].toLowerCase().trim();\n    break;\n  }\n}\n\n// MR Î≤àÌò∏ Ï∂îÏ∂ú\nlet mrNumber = null;\nfor (const pattern of mrPatterns) {\n  const match = text.match(pattern);\n  if (match) {\n    mrNumber = match[1];\n    break;\n  }\n}\n\nif (mrNumber) {\n  const reviewKeywords = ['Î¶¨Î∑∞', 'review', 'Í≤ÄÌÜ†', 'Î¥êÏ§ò', 'ÌôïÏù∏', 'ÏΩîÎìúÎ¶¨Î∑∞', 'cr ', 'code review'];\n  const hasReviewKeyword = reviewKeywords.some(k => text.toLowerCase().includes(k.toLowerCase()));\n  \n  if (hasReviewKeyword) {\n    result.messageType = 'mr-review';\n    result.isMrReview = true;\n    result.mrNumber = mrNumber;\n    result.projectHint = projectHint;\n    return { json: result };\n  }\n}\n\nreturn { json: result };"
      },
      "id": "classify-message",
      "name": "Classify Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.messageType }}",
              "operation": "notEquals",
              "value2": "command"
            }
          ]
        }
      },
      "id": "is-command",
      "name": "Is Command?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "mr-review-check",
              "leftValue": "={{ $json.isMrReview }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "is-mr-review",
      "name": "Is MR Review?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/command",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ text: $('Webhook').item.json.body.text, channel: $('Webhook').item.json.body.channel }) }}",
        "options": { "timeout": 10000 }
      },
      "id": "execute-command",
      "name": "Execute Command",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [900, 100],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/slack/message",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $('Webhook').item.json.body.channel, text: $json.response || 'Î™ÖÎ†πÏñ¥ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', threadTs: $('Webhook').item.json.body.threadTs || $('Webhook').item.json.body.timestamp }) }}"
      },
      "id": "send-command-response",
      "name": "Send Command Response",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1150, 100],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/slack/reaction",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $('Webhook').item.json.body.channel, timestamp: $('Webhook').item.json.body.timestamp, emoji: 'hourglass_flowing_sand', remove: false }) }}"
      },
      "id": "add-loading-mr",
      "name": "Add Loading (MR)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1050, 250],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// MR Ïª®ÌÖçÏä§Ìä∏ Ï°∞Ìöå (scheduled-mr-reviewÏôÄ ÎèôÏùºÌïú Î∞©Ïãù)\nconst classifyData = $('Classify Message').first().json;\nconst apiUrl = process.env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080';\n\nconst mrNumber = classifyData.mrNumber;\nlet project = classifyData.projectHint;\n\nif (!project) {\n  project = process.env.GITLAB_GROUP || 'sirius/ccds';\n}\n\nconsole.log('Fetching MR context:', project, mrNumber);\n\ntry {\n  const contextUrl = `${apiUrl}/api/v1/mr-review/context/${encodeURIComponent(project)}/${mrNumber}`;\n  const contextResponse = await this.helpers.httpRequest({\n    method: 'GET',\n    url: contextUrl,\n    json: true,\n    timeout: 120000\n  });\n\n  if (!contextResponse.success || !contextResponse.context) {\n    return {\n      json: {\n        error: contextResponse.error || 'MR Ïª®ÌÖçÏä§Ìä∏ Ï°∞Ìöå Ïã§Ìå®',\n        mrNumber: mrNumber,\n        project: project\n      }\n    };\n  }\n\n  return {\n    json: {\n      mrNumber: mrNumber,\n      project: project,\n      mrContext: contextResponse.context,\n      mrTitle: contextResponse.mrTitle,\n      mrUrl: contextResponse.mrUrl,\n      issueCount: contextResponse.issueCount || 0,\n      fileCount: contextResponse.fileCount || 0\n    }\n  };\n} catch (e) {\n  return {\n    json: {\n      error: e.message,\n      mrNumber: mrNumber,\n      project: project\n    }\n  };\n}"
      },
      "id": "get-mr-context",
      "name": "Get MR Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 250]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.error }}",
              "operation": "isEmpty"
            }
          ]
        }
      },
      "id": "mr-context-ok",
      "name": "Context OK?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1450, 250]
    },
    {
      "parameters": {
        "jsCode": "// AI Î¶¨Î∑∞ Ïã§Ìñâ\nconst mrData = $input.item.json;\nconst apiUrl = process.env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080';\n\nconst reviewPrompt = `## MR Î¶¨Î∑∞ ÏöîÏ≤≠\\n\\n**ÌîÑÎ°úÏ†ùÌä∏**: ${mrData.project}\\n**MR**: !${mrData.mrNumber} - ${mrData.mrTitle || ''}\\n**URL**: ${mrData.mrUrl || ''}\\n\\n---\\n\\n${mrData.mrContext}\\n\\n---\\n\\nÏúÑ MR Î∂ÑÏÑù Í≤∞Í≥ºÎ•º Î∞îÌÉïÏúºÎ°ú ÏΩîÎìú Î¶¨Î∑∞Î•º ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.\\n\\n**Î¶¨Î∑∞ ÌòïÏãù:**\\n### ÏöîÏïΩ\\n### Ïû•Ï†ê\\n### Í∞úÏÑ† ÏÇ¨Ìï≠\\n### Ï†ÑÏ≤¥ ÌèâÍ∞Ä (‚≠ê/10)`;\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: apiUrl + '/api/v1/chat/execute',\n    body: {\n      messages: [{ role: 'user', content: reviewPrompt }],\n      projectId: mrData.project,\n      agentId: 'code-reviewer',\n      skipMrAnalysis: true,\n      source: 'slack'\n    },\n    json: true,\n    timeout: 600000\n  });\n\n  if (!response.success || !response.content) {\n    return { json: { ...mrData, error: response.error || 'AI Î¶¨Î∑∞ Ïã§Ìå®' } };\n  }\n\n  return {\n    json: {\n      ...mrData,\n      aiReview: response.content,\n      reviewSuccess: true\n    }\n  };\n} catch (e) {\n  return { json: { ...mrData, error: e.message } };\n}"
      },
      "id": "execute-mr-review",
      "name": "Execute MR Review",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 200]
    },
    {
      "parameters": {
        "jsCode": "// GitLabÏóê ÏΩîÎ©òÌä∏ ÏûëÏÑ±\nconst mrData = $input.item.json;\nconst apiUrl = process.env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080';\n\nif (!mrData.reviewSuccess || mrData.error) {\n  return { json: mrData };\n}\n\nconst gitlabComment = `## ü§ñ AI Code Review\\n\\n${mrData.aiReview}\\n\\n---\\n_Generated by Claude Flow_`;\n\ntry {\n  await this.helpers.httpRequest({\n    method: 'POST',\n    url: apiUrl + '/api/v1/plugins/gitlab/execute',\n    body: {\n      command: 'mr-comment',\n      args: {\n        project: mrData.project,\n        mr_id: mrData.mrNumber,\n        comment: gitlabComment\n      }\n    },\n    json: true,\n    timeout: 30000\n  });\n  \n  // ÎùºÎ≤® Ï†ÅÏö©\n  await this.helpers.httpRequest({\n    method: 'POST',\n    url: apiUrl + '/api/v1/plugins/gitlab/execute',\n    body: {\n      command: 'mr-add-label',\n      args: {\n        project: mrData.project,\n        mr_id: mrData.mrNumber,\n        label: 'ai-review::done'\n      }\n    },\n    json: true,\n    timeout: 10000\n  });\n} catch (e) {\n  console.log('GitLab comment error:', e.message);\n}\n\nreturn { json: mrData };"
      },
      "id": "post-gitlab-comment",
      "name": "Post GitLab Comment",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1850, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/slack/reaction",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $('Webhook').item.json.body.channel, timestamp: $('Webhook').item.json.body.timestamp, emoji: 'hourglass_flowing_sand', remove: true }) }}"
      },
      "id": "remove-loading-mr",
      "name": "Remove Loading (MR)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2050, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/slack/message",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $('Webhook').item.json.body.channel, text: '‚úÖ MR !' + $json.mrNumber + ' Î¶¨Î∑∞ ÏôÑÎ£å\\n\\n' + ($json.aiReview || '').substring(0, 2000) + ($json.aiReview && $json.aiReview.length > 2000 ? '\\n\\n_(GitLabÏóêÏÑú Ï†ÑÏ≤¥ Î¶¨Î∑∞ ÌôïÏù∏)_' : ''), threadTs: $('Webhook').item.json.body.threadTs || $('Webhook').item.json.body.timestamp }) }}"
      },
      "id": "send-mr-response",
      "name": "Send MR Response",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2250, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/slack/reaction",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $('Webhook').item.json.body.channel, timestamp: $('Webhook').item.json.body.timestamp, emoji: 'white_check_mark', remove: false }) }}"
      },
      "id": "add-success-mr",
      "name": "Add ‚úÖ (MR)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2450, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/slack/message",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $('Webhook').item.json.body.channel, text: '‚ùå MR Î¶¨Î∑∞ Ïã§Ìå®: ' + $json.error, threadTs: $('Webhook').item.json.body.threadTs || $('Webhook').item.json.body.timestamp }) }}"
      },
      "id": "send-mr-error",
      "name": "Send MR Error",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 350],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/slack/reaction",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $('Webhook').item.json.body.channel, timestamp: $('Webhook').item.json.body.timestamp, emoji: 'hourglass_flowing_sand', remove: false }) }}"
      },
      "id": "add-loading",
      "name": "Add Loading",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1050, 500],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/slack/thread-history",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $('Webhook').item.json.body.channel, threadTs: $('Webhook').item.json.body.threadTs || $('Webhook').item.json.body.timestamp, limit: 20 }) }}",
        "options": { "timeout": 10000 }
      },
      "id": "get-thread-history",
      "name": "Get Thread History",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1250, 500],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Ïä§Î†àÎìú ÌûàÏä§ÌÜ†Î¶¨Î•º ÎåÄÌôî ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò\nconst webhookBody = $('Webhook').item.json.body;\nconst historyResponse = $input.item.json;\n\nlet conversationHistory = [];\n\nif (historyResponse && historyResponse.success && historyResponse.messages && historyResponse.messages.length > 1) {\n  const previousMessages = historyResponse.messages.slice(0, -1);\n  conversationHistory = previousMessages.map(msg => ({\n    role: msg.isBot ? 'assistant' : 'user',\n    content: msg.text.replace(/<@[A-Z0-9]+>/g, '').trim(),\n    userName: msg.userName || msg.user\n  })).filter(msg => msg.content.length > 0);\n}\n\nreturn {\n  json: {\n    channel: webhookBody.channel,\n    text: webhookBody.text,\n    threadTs: webhookBody.threadTs || webhookBody.timestamp,\n    timestamp: webhookBody.timestamp,\n    user: webhookBody.user,\n    conversationHistory: conversationHistory\n  }\n};"
      },
      "id": "format-history",
      "name": "Format History",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 500]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/execute-with-routing",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ prompt: $json.text, maxTurns: 50, conversationHistory: $json.conversationHistory, channel: $json.channel, threadTs: $json.threadTs, userId: $json.user, source: 'slack' }) }}",
        "options": { "timeout": 900000 }
      },
      "id": "execute-claude",
      "name": "Execute Claude",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 500],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/slack/reaction",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $('Webhook').item.json.body.channel, timestamp: $('Webhook').item.json.body.timestamp, emoji: 'hourglass_flowing_sand', remove: true }) }}"
      },
      "id": "remove-loading",
      "name": "Remove Loading",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1850, 500],
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.success === true }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-success",
      "name": "Success?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2050, 500]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/slack/message",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $('Webhook').item.json.body.channel, text: ($('Execute Claude').item.json.projectId ? 'üìÅ [' + $('Execute Claude').item.json.projectId + '] ' : '') + ($('Execute Claude').item.json.routedAgent ? 'ü§ñ [' + $('Execute Claude').item.json.routedAgent + ']\\n' : '') + ($('Execute Claude').item.json.result || $('Execute Claude').item.json.error || 'ÏùëÎãµÏù¥ ÏóÜÏäµÎãàÎã§.'), threadTs: $('Webhook').item.json.body.threadTs || $('Webhook').item.json.body.timestamp }) }}"
      },
      "id": "send-reply",
      "name": "Send Reply",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2250, 450],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/slack/message",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $('Webhook').item.json.body.channel, text: '‚ùå Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + ($('Execute Claude').item.json.error || 'Unknown error'), threadTs: $('Webhook').item.json.body.threadTs || $('Webhook').item.json.body.timestamp }) }}"
      },
      "id": "send-error",
      "name": "Send Error",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2250, 600],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{ ($env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080') + '/api/v1/executions/' + $('Execute Claude').item.json.requestId + '/reply-ts' }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ replyTs: $('Send Reply').item.json.timestamp }) }}",
        "options": { "timeout": 5000 }
      },
      "id": "save-reply-ts",
      "name": "Save Reply TS",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2450, 450],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/slack/reaction",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $('Webhook').item.json.body.channel, timestamp: $('Webhook').item.json.body.timestamp, emoji: 'white_check_mark', remove: false }) }}"
      },
      "id": "add-success-reaction",
      "name": "Add ‚úÖ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2650, 400],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/slack/reaction",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $('Webhook').item.json.body.channel, timestamp: $('Webhook').item.json.body.timestamp, emoji: 'x', remove: false }) }}"
      },
      "id": "add-error-reaction",
      "name": "Add ‚ùå",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2450, 600],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/slack/reaction",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $('Webhook').item.json.body.channel, timestamp: $('Send Reply').item.json.timestamp, emoji: 'thumbsup', remove: false }) }}"
      },
      "id": "add-thumbsup",
      "name": "Add üëç",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2850, 350],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/slack/reaction",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $('Webhook').item.json.body.channel, timestamp: $('Send Reply').item.json.timestamp, emoji: 'thumbsdown', remove: false }) }}"
      },
      "id": "add-thumbsdown",
      "name": "Add üëé",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2850, 450],
      "continueOnFail": true
    }
  ],
  "connections": {
    "Webhook": {
      "main": [[{ "node": "Classify Message", "type": "main", "index": 0 }]]
    },
    "Classify Message": {
      "main": [[{ "node": "Is Command?", "type": "main", "index": 0 }]]
    },
    "Is Command?": {
      "main": [
        [{ "node": "Is MR Review?", "type": "main", "index": 0 }],
        [{ "node": "Execute Command", "type": "main", "index": 0 }]
      ]
    },
    "Is MR Review?": {
      "main": [
        [{ "node": "Add Loading (MR)", "type": "main", "index": 0 }],
        [{ "node": "Add Loading", "type": "main", "index": 0 }]
      ]
    },
    "Execute Command": {
      "main": [[{ "node": "Send Command Response", "type": "main", "index": 0 }]]
    },
    "Add Loading (MR)": {
      "main": [[{ "node": "Get MR Context", "type": "main", "index": 0 }]]
    },
    "Get MR Context": {
      "main": [[{ "node": "Context OK?", "type": "main", "index": 0 }]]
    },
    "Context OK?": {
      "main": [
        [{ "node": "Execute MR Review", "type": "main", "index": 0 }],
        [{ "node": "Send MR Error", "type": "main", "index": 0 }]
      ]
    },
    "Execute MR Review": {
      "main": [[{ "node": "Post GitLab Comment", "type": "main", "index": 0 }]]
    },
    "Post GitLab Comment": {
      "main": [[{ "node": "Remove Loading (MR)", "type": "main", "index": 0 }]]
    },
    "Remove Loading (MR)": {
      "main": [[{ "node": "Send MR Response", "type": "main", "index": 0 }]]
    },
    "Send MR Response": {
      "main": [[{ "node": "Add ‚úÖ (MR)", "type": "main", "index": 0 }]]
    },
    "Add Loading": {
      "main": [[{ "node": "Get Thread History", "type": "main", "index": 0 }]]
    },
    "Get Thread History": {
      "main": [[{ "node": "Format History", "type": "main", "index": 0 }]]
    },
    "Format History": {
      "main": [[{ "node": "Execute Claude", "type": "main", "index": 0 }]]
    },
    "Execute Claude": {
      "main": [[{ "node": "Remove Loading", "type": "main", "index": 0 }]]
    },
    "Remove Loading": {
      "main": [[{ "node": "Success?", "type": "main", "index": 0 }]]
    },
    "Success?": {
      "main": [
        [{ "node": "Send Reply", "type": "main", "index": 0 }],
        [{ "node": "Send Error", "type": "main", "index": 0 }]
      ]
    },
    "Send Reply": {
      "main": [[{ "node": "Save Reply TS", "type": "main", "index": 0 }]]
    },
    "Save Reply TS": {
      "main": [[{ "node": "Add ‚úÖ", "type": "main", "index": 0 }]]
    },
    "Send Error": {
      "main": [[{ "node": "Add ‚ùå", "type": "main", "index": 0 }]]
    },
    "Add ‚úÖ": {
      "main": [[
        { "node": "Add üëç", "type": "main", "index": 0 },
        { "node": "Add üëé", "type": "main", "index": 0 }
      ]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  }
}
