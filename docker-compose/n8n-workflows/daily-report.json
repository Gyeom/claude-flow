{
  "name": "Daily Usage Report",
  "versionId": "daily-report-v1",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * 1-5"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Every Weekday 9AM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [250, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://host.docker.internal:8080/api/v1/stats",
        "options": {
          "timeout": 10000
        }
      },
      "id": "fetch-stats",
      "name": "Fetch Stats",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [450, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://host.docker.internal:8080/api/v1/executions/recent?limit=100",
        "options": {
          "timeout": 10000
        }
      },
      "id": "fetch-executions",
      "name": "Fetch Recent Executions",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [450, 450],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ÌÜµÍ≥Ñ Î∞è Ïã§Ìñâ Îç∞Ïù¥ÌÑ∞ Î≥ëÌï©\nconst stats = $('Fetch Stats').item.json;\nconst executions = $('Fetch Recent Executions').item.json;\n\n// Ïò§Îäò ÎÇ†Ïßú Í∏∞Ï§Ä ÌïÑÌÑ∞ÎßÅ\nconst today = new Date();\ntoday.setHours(0, 0, 0, 0);\nconst yesterday = new Date(today);\nyesterday.setDate(yesterday.getDate() - 1);\n\nconst todayExecutions = executions.filter(e => {\n  const created = new Date(e.createdAt);\n  return created >= yesterday && created < today;\n});\n\n// ÏóêÏù¥Ï†ÑÌä∏Î≥Ñ ÏÇ¨Ïö©Îüâ\nconst agentUsage = {};\nfor (const exec of todayExecutions) {\n  const agent = exec.agentId || 'unknown';\n  if (!agentUsage[agent]) {\n    agentUsage[agent] = { count: 0, success: 0, tokens: 0 };\n  }\n  agentUsage[agent].count++;\n  if (exec.status === 'SUCCESS') {\n    agentUsage[agent].success++;\n  }\n  agentUsage[agent].tokens += (exec.inputTokens || 0) + (exec.outputTokens || 0);\n}\n\n// ÏÇ¨Ïö©ÏûêÎ≥Ñ ÏÇ¨Ïö©Îüâ\nconst userUsage = {};\nfor (const exec of todayExecutions) {\n  const user = exec.userId || 'unknown';\n  if (!userUsage[user]) {\n    userUsage[user] = 0;\n  }\n  userUsage[user]++;\n}\n\n// ÏÉÅÏúÑ 5Î™Ö ÏÇ¨Ïö©Ïûê\nconst topUsers = Object.entries(userUsage)\n  .sort((a, b) => b[1] - a[1])\n  .slice(0, 5);\n\nreturn {\n  json: {\n    date: yesterday.toISOString().split('T')[0],\n    totalExecutions: todayExecutions.length,\n    successRate: todayExecutions.length > 0 \n      ? (todayExecutions.filter(e => e.status === 'SUCCESS').length / todayExecutions.length * 100).toFixed(1)\n      : 0,\n    totalTokens: todayExecutions.reduce((sum, e) => sum + (e.inputTokens || 0) + (e.outputTokens || 0), 0),\n    agentUsage,\n    topUsers,\n    overallStats: stats\n  }\n};"
      },
      "id": "process-data",
      "name": "Process Report Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [700, 375]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\n\nlet agentSection = '';\nfor (const [agent, usage] of Object.entries(data.agentUsage)) {\n  const successRate = usage.count > 0 ? (usage.success / usage.count * 100).toFixed(1) : 0;\n  agentSection += `‚Ä¢ *${agent}*: ${usage.count}Ìöå (ÏÑ±Í≥µÎ•† ${successRate}%, ${usage.tokens.toLocaleString()} tokens)\\n`;\n}\n\nlet userSection = '';\nfor (const [user, count] of data.topUsers) {\n  userSection += `‚Ä¢ <@${user}>: ${count}Ìöå\\n`;\n}\n\nconst message = {\n  blocks: [\n    {\n      type: 'header',\n      text: {\n        type: 'plain_text',\n        text: `üìä Claude Flow Daily Report - ${data.date}`,\n        emoji: true\n      }\n    },\n    {\n      type: 'section',\n      text: {\n        type: 'mrkdwn',\n        text: `*ÏùºÏùº ÏöîÏïΩ*\\n‚Ä¢ Ï¥ù Ïã§Ìñâ: *${data.totalExecutions}Ìöå*\\n‚Ä¢ ÏÑ±Í≥µÎ•†: *${data.successRate}%*\\n‚Ä¢ ÏÇ¨Ïö© ÌÜ†ÌÅ∞: *${data.totalTokens.toLocaleString()}* tokens`\n      }\n    },\n    {\n      type: 'divider'\n    },\n    {\n      type: 'section',\n      text: {\n        type: 'mrkdwn',\n        text: `*ÏóêÏù¥Ï†ÑÌä∏Î≥Ñ ÏÇ¨Ïö©Îüâ*\\n${agentSection || '‚Ä¢ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'}`\n      }\n    },\n    {\n      type: 'divider'\n    },\n    {\n      type: 'section',\n      text: {\n        type: 'mrkdwn',\n        text: `*Top 5 ÏÇ¨Ïö©Ïûê*\\n${userSection || '‚Ä¢ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'}`\n      }\n    },\n    {\n      type: 'divider'\n    },\n    {\n      type: 'section',\n      text: {\n        type: 'mrkdwn',\n        text: `*ÎàÑÏ†Å ÌÜµÍ≥Ñ*\\n‚Ä¢ Ï¥ù Ïã§Ìñâ: ${data.overallStats?.totalExecutions || 0}Ìöå\\n‚Ä¢ Ï†ÑÏ≤¥ ÏÑ±Í≥µÎ•†: ${((data.overallStats?.successRate || 0) * 100).toFixed(1)}%\\n‚Ä¢ üëç ${data.overallStats?.thumbsUp || 0} / üëé ${data.overallStats?.thumbsDown || 0}`\n      }\n    },\n    {\n      type: 'context',\n      elements: [\n        {\n          type: 'mrkdwn',\n          text: '_Generated by Claude Flow_'\n        }\n      ]\n    }\n  ]\n};\n\nreturn { json: message };"
      },
      "id": "format-message",
      "name": "Format Slack Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 375]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $env.SLACK_REPORT_CHANNEL || '#claude-flow-reports', blocks: $json.blocks }) }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Bearer {{ $env.SLACK_BOT_TOKEN }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        }
      },
      "id": "post-to-slack",
      "name": "Post Report to Slack",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1100, 375],
      "continueOnFail": true
    }
  ],
  "connections": {
    "Every Weekday 9AM": {
      "main": [
        [
          { "node": "Fetch Stats", "type": "main", "index": 0 },
          { "node": "Fetch Recent Executions", "type": "main", "index": 0 }
        ]
      ]
    },
    "Fetch Stats": {
      "main": [
        [{ "node": "Process Report Data", "type": "main", "index": 0 }]
      ]
    },
    "Fetch Recent Executions": {
      "main": [
        [{ "node": "Process Report Data", "type": "main", "index": 0 }]
      ]
    },
    "Process Report Data": {
      "main": [
        [{ "node": "Format Slack Message", "type": "main", "index": 0 }]
      ]
    },
    "Format Slack Message": {
      "main": [
        [{ "node": "Post Report to Slack", "type": "main", "index": 0 }]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  }
}
