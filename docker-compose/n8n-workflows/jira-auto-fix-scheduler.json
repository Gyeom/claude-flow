{
  "name": "JIRA Auto Fix Scheduler",
  "versionId": "jira-auto-fix-v1",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "*/10 * * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Every 10 Minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [250, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $env.JIRA_URL }}/rest/api/3/search",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            { "name": "jql", "value": "labels = 'ai:auto-fix' AND status != Done AND updated >= -1h" },
            { "name": "maxResults", "value": "10" },
            { "name": "fields", "value": "summary,description,labels,status,project,issuetype" }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Basic {{ $env.JIRA_AUTH }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "fetch-jira-issues",
      "name": "Fetch JIRA Issues",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [450, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const response = $input.item.json;\nconst results = [];\n\nif (response.issues && Array.isArray(response.issues)) {\n  for (const issue of response.issues) {\n    const labels = issue.fields?.labels || [];\n    \n    // ai:auto-fixëŠ” ìˆê³  ai:processingì€ ì—†ëŠ” ì´ìŠˆë§Œ\n    if (labels.includes('ai:auto-fix') && !labels.includes('ai:processing')) {\n      results.push({\n        json: {\n          key: issue.key,\n          id: issue.id,\n          summary: issue.fields?.summary || '',\n          description: issue.fields?.description?.content?.[0]?.content?.[0]?.text || issue.fields?.description || '',\n          project: issue.fields?.project?.key,\n          issueType: issue.fields?.issuetype?.name,\n          status: issue.fields?.status?.name\n        }\n      });\n    }\n  }\n}\n\nreturn results.length > 0 ? results : [{ json: { skip: true } }];"
      },
      "id": "filter-issues",
      "name": "Filter Pending Issues",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.skip }}",
              "value2": true,
              "operation": "notEqual"
            }
          ]
        }
      },
      "id": "check-has-issues",
      "name": "Has Issues?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "={{ $env.JIRA_URL }}/rest/api/3/issue/{{ $json.key }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ update: { labels: [{ add: 'ai:processing' }] } }) }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Basic {{ $env.JIRA_AUTH }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        }
      },
      "id": "add-processing-label",
      "name": "Add Processing Label",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1050, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const issue = $('Filter Pending Issues').item.json;\n\nconst prompt = `JIRA ì´ìŠˆë¥¼ ë¶„ì„í•˜ê³  í•´ê²°ì±…ì„ ì œì•ˆí•´ì£¼ì„¸ìš”.\n\n## ì´ìŠˆ ì •ë³´\n- í‚¤: ${issue.key}\n- ì œëª©: ${issue.summary}\n- í”„ë¡œì íŠ¸: ${issue.project}\n- íƒ€ì…: ${issue.issueType}\n- ìƒíƒœ: ${issue.status}\n\n## ì„¤ëª…\n${issue.description || 'ì„¤ëª… ì—†ìŒ'}\n\n## ìš”ì²­ì‚¬í•­\n1. ì´ìŠˆì˜ ê·¼ë³¸ ì›ì¸ ë¶„ì„\n2. í•´ê²° ë°©ì•ˆ ì œì•ˆ (êµ¬ì²´ì ì¸ ì½”ë“œ ì˜ˆì‹œ í¬í•¨)\n3. í…ŒìŠ¤íŠ¸ ë°©ë²•\n4. ì˜ˆìƒ ì˜í–¥ë„\n\ní•œêµ­ì–´ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”.`;\n\nreturn {\n  json: {\n    ...issue,\n    prompt\n  }\n};"
      },
      "id": "prepare-prompt",
      "name": "Prepare Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:8080/api/v1/execute",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ prompt: $json.prompt, agentId: 'bug-fixer', maxTurns: 10 }) }}",
        "options": {
          "timeout": 300000
        }
      },
      "id": "claude-analysis",
      "name": "Claude Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1450, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.JIRA_URL }}/rest/api/3/issue/{{ $('Prepare Prompt').item.json.key }}/comment",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ body: { type: 'doc', version: 1, content: [{ type: 'paragraph', content: [{ type: 'text', text: 'ğŸ¤– AI Analysis Result' }] }, { type: 'codeBlock', attrs: { language: 'markdown' }, content: [{ type: 'text', text: $json.result || $json.error || 'Analysis failed' }] }] } }) }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Basic {{ $env.JIRA_AUTH }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        }
      },
      "id": "post-comment",
      "name": "Post Comment",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "={{ $env.JIRA_URL }}/rest/api/3/issue/{{ $('Prepare Prompt').item.json.key }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ update: { labels: [{ add: 'ai:analyzed' }, { remove: 'ai:auto-fix' }, { remove: 'ai:processing' }] } }) }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Basic {{ $env.JIRA_AUTH }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        }
      },
      "id": "update-labels",
      "name": "Update Labels",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1850, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ channel: $env.SLACK_JIRA_CHANNEL || '#jira-updates', text: 'ğŸ¤– AI ë¶„ì„ ì™„ë£Œ: <' + $env.JIRA_URL + '/browse/' + $('Prepare Prompt').item.json.key + '|' + $('Prepare Prompt').item.json.key + '> - ' + $('Prepare Prompt').item.json.summary }) }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Bearer {{ $env.SLACK_BOT_TOKEN }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        }
      },
      "id": "notify-slack",
      "name": "Notify Slack",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2050, 200],
      "continueOnFail": true
    }
  ],
  "connections": {
    "Every 10 Minutes": {
      "main": [
        [{ "node": "Fetch JIRA Issues", "type": "main", "index": 0 }]
      ]
    },
    "Fetch JIRA Issues": {
      "main": [
        [{ "node": "Filter Pending Issues", "type": "main", "index": 0 }]
      ]
    },
    "Filter Pending Issues": {
      "main": [
        [{ "node": "Has Issues?", "type": "main", "index": 0 }]
      ]
    },
    "Has Issues?": {
      "main": [
        [{ "node": "Add Processing Label", "type": "main", "index": 0 }],
        []
      ]
    },
    "Add Processing Label": {
      "main": [
        [{ "node": "Prepare Prompt", "type": "main", "index": 0 }]
      ]
    },
    "Prepare Prompt": {
      "main": [
        [{ "node": "Claude Analysis", "type": "main", "index": 0 }]
      ]
    },
    "Claude Analysis": {
      "main": [
        [{ "node": "Post Comment", "type": "main", "index": 0 }]
      ]
    },
    "Post Comment": {
      "main": [
        [{ "node": "Update Labels", "type": "main", "index": 0 }]
      ]
    },
    "Update Labels": {
      "main": [
        [{ "node": "Notify Slack", "type": "main", "index": 0 }]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  }
}
