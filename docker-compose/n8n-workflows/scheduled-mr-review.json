{
  "name": "Scheduled MR Auto Review",
  "meta": {
    "description": "5Î∂ÑÎßàÎã§ GitLabÏóêÏÑú ÏÉà MRÏùÑ ÌôïÏù∏ÌïòÍ≥† ÏûêÎèôÏúºÎ°ú AI ÏΩîÎìú Î¶¨Î∑∞Î•º ÏàòÌñâÌï©ÎãàÎã§. ai-review ÎùºÎ≤®Ïù¥ ÏûàÎäî MRÏùÑ ÎåÄÏÉÅÏúºÎ°ú Ìï©ÎãàÎã§."
  },
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "*/5 * * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080' }}/api/v1/projects/gitlab-enabled",
        "options": { "timeout": 10000 }
      },
      "id": "get-projects",
      "name": "Get GitLab Projects",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [440, 300],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ Array.isArray($json) ? $json.length > 0 : ($json.id !== undefined) }}",
              "value2": true
            }
          ]
        }
      },
      "id": "has-projects",
      "name": "Has Projects?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [640, 300]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Í∞Å ÌîÑÎ°úÏ†ùÌä∏ Ìï≠Î™©ÏùÑ Í∞úÎ≥Ñ Ï≤òÎ¶¨\nconst project = $input.item.json;\n\nif (project.error || project.message) {\n  return { json: { error: project.error || project.message, skip: true } };\n}\n\nif (!project.id || !project.gitlabPath) {\n  return { json: { error: 'Invalid project data', skip: true } };\n}\n\nreturn { json: project };"
      },
      "id": "split-projects",
      "name": "Split Projects",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [840, 200]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Claude Flow APIÎ•º ÌÜµÌï¥ GitLab MR Î™©Î°ù Ï°∞Ìöå\nconst project = $input.item.json;\nconst apiUrl = process.env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080';\n\nif (project.skip) {\n  return { json: project };\n}\n\nconsole.log('Fetching MRs for project:', project.id, project.gitlabPath);\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: apiUrl + '/api/v1/plugins/gitlab/execute',\n    body: {\n      command: 'mr-list',\n      args: { project: project.gitlabPath }\n    },\n    json: true,\n    timeout: 30000\n  });\n\n  if (!response.success || !response.data) {\n    console.log('Failed to get MRs:', response.error);\n    return { json: { skip: true, reason: response.error || 'No MRs', project: project.id } };\n  }\n\n  const mrs = response.data;\n  if (!Array.isArray(mrs) || mrs.length === 0) {\n    console.log('No MRs for project:', project.id);\n    return { json: { skip: true, reason: 'No MRs', project: project.id } };\n  }\n\n  // 1. target_branchÍ∞Ä developÏù∏ MRÎßå ÌïÑÌÑ∞ÎßÅ\n  // 2. ai-review::done ÎòêÎäî ai-review::in-progress ÎùºÎ≤®Ïù¥ ÏûàÎäî MR Ï†úÏô∏\n  const filteredMRs = mrs.filter(mr => {\n    // target_branch ÌôïÏù∏\n    if (mr.target_branch !== (project.defaultBranch || 'develop')) {\n      return false;\n    }\n    // ai-review ÎùºÎ≤® ÌôïÏù∏ (Ïù¥ÎØ∏ Î¶¨Î∑∞Îêú MR Ï†úÏô∏)\n    const labels = mr.labels || [];\n    const hasAiReviewLabel = labels.some(label => \n      label === 'ai-review::done' || \n      label === 'ai-review::in-progress' ||\n      label === 'ai-review::skip'\n    );\n    if (hasAiReviewLabel) {\n      console.log('Skipping MR', mr.iid, '- already has ai-review label:', labels.filter(l => l.startsWith('ai-review')));\n      return false;\n    }\n    return true;\n  });\n\n  if (filteredMRs.length === 0) {\n    console.log('No reviewable MRs for project:', project.id, '(all filtered out)');\n    return { json: { skip: true, reason: 'No reviewable MRs (already reviewed or wrong target branch)', project: project.id } };\n  }\n\n  console.log('Found', filteredMRs.length, 'reviewable MRs for project:', project.id);\n  return { json: { mrs: filteredMRs, projectInfo: project } };\n} catch (e) {\n  console.log('Error fetching MRs:', e.message);\n  return { json: { skip: true, reason: e.message, project: project.id } };\n}"
      },
      "id": "get-project-mrs",
      "name": "Get Project MRs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1040, 200]
    },
    {
      "parameters": {
        "jsCode": "// MR Î∞∞Ïó¥ÏùÑ Í∞úÎ≥Ñ ÏïÑÏù¥ÌÖúÏúºÎ°ú Î∂ÑÌï† (Î™®Îì† ÏûÖÎ†• Ï≤òÎ¶¨)\nconst allItems = $input.all();\nconst results = [];\n\nfor (const item of allItems) {\n  const data = item.json;\n  \n  if (data.skip || !data.mrs) {\n    // skip ÏïÑÏù¥ÌÖúÏùÄ Í∑∏ÎåÄÎ°ú Ï†ÑÎã¨ (Should Review?ÏóêÏÑú ÌïÑÌÑ∞ÎßÅÎê®)\n    results.push({ json: data });\n    continue;\n  }\n  \n  const project = data.projectInfo;\n  console.log('Splitting', data.mrs.length, 'MRs for project:', project?.id);\n  \n  for (const mr of data.mrs) {\n    results.push({\n      json: {\n        mr_iid: mr.iid,\n        mr_title: mr.title,\n        mr_author: mr.author,\n        source_branch: mr.source_branch,\n        target_branch: mr.target_branch,\n        mr_url: mr.web_url,\n        created_at: mr.created_at,\n        projectInfo: project\n      }\n    });\n  }\n}\n\nconsole.log('Total output items:', results.length);\nreturn results;"
      },
      "id": "split-mrs",
      "name": "Split MRs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1240, 200]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.skip !== true && $json.mr_iid !== undefined }}",
              "value2": true
            }
          ]
        }
      },
      "id": "should-review",
      "name": "Should Review?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1440, 200]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Claude Flow APIÎ•º ÌÜµÌï¥ MR ÏÉÅÏÑ∏ Ï†ïÎ≥¥(changes Ìè¨Ìï®) Ï°∞Ìöå\nconst mr = $input.item.json;\nconst apiUrl = process.env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080';\n\nconsole.log('Fetching MR details for:', mr.mr_iid, 'project:', mr.projectInfo?.gitlabPath);\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: apiUrl + '/api/v1/plugins/gitlab/execute',\n    body: {\n      command: 'mr-info',\n      args: {\n        project: mr.projectInfo.gitlabPath,\n        mr_id: mr.mr_iid\n      }\n    },\n    json: true,\n    timeout: 60000\n  });\n\n  if (!response.success || !response.data) {\n    console.log('Failed to get MR info:', response.error);\n    return { json: { ...mr, skip: true, error: response.error || 'Failed to get MR info' } };\n  }\n\n  const mrInfo = response.data;\n  console.log('Got MR info:', mrInfo.iid, mrInfo.title?.substring(0, 30));\n\n  return {\n    json: {\n      ...mr,\n      mr_description: mrInfo.description,\n      mr_state: mrInfo.state,\n      merge_status: mrInfo.merge_status,\n      has_conflicts: mrInfo.has_conflicts\n    }\n  };\n} catch (e) {\n  console.log('Error fetching MR info:', e.message);\n  return { json: { ...mr, skip: true, error: e.message } };\n}"
      },
      "id": "get-mr-details",
      "name": "Get MR Details",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1640, 100]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ChatStreamControllerÏùò performMrAnalysis()ÏôÄ ÎèôÏùºÌïú Î©îÏª§ÎãàÏ¶ò ÏÇ¨Ïö©\n// 1. /context ÏóîÎìúÌè¨Ïù∏Ìä∏Î°ú Ìè¨Îß∑ÌåÖÎêú Ïª®ÌÖçÏä§Ìä∏ Ï°∞Ìöå\n// 2. Ïª®ÌÖçÏä§Ìä∏Î•º Ìè¨Ìï®Ìïú ÌîÑÎ°¨ÌîÑÌä∏Î°ú Chat API Ìò∏Ï∂ú\nconst mr = $input.item.json;\nconst apiUrl = process.env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080';\n\nif (mr.skip) {\n  console.log('Skipping review:', mr.error);\n  return { json: mr };\n}\n\nconst projectId = mr.projectInfo?.id || 'ccds-server';\nconst gitlabPath = mr.projectInfo?.gitlabPath;\n\nconsole.log('Starting review for MR:', mr.mr_iid, 'project:', gitlabPath);\n\ntry {\n  // 1Îã®Í≥Ñ: /context ÏóîÎìúÌè¨Ïù∏Ìä∏Î°ú ChatStreamControllerÏôÄ ÎèôÏùºÌïú Ìè¨Îß∑Ïùò Ïª®ÌÖçÏä§Ìä∏ Ï°∞Ìöå\n  const contextUrl = `${apiUrl}/api/v1/mr-review/context/${encodeURIComponent(gitlabPath)}/${mr.mr_iid}`;\n  console.log('Fetching context from:', contextUrl);\n  \n  const contextResponse = await this.helpers.httpRequest({\n    method: 'GET',\n    url: contextUrl,\n    json: true,\n    timeout: 120000  // 2Î∂Ñ ÌÉÄÏûÑÏïÑÏõÉ\n  });\n\n  if (!contextResponse.success || !contextResponse.context) {\n    console.log('Failed to get context:', contextResponse.error);\n    return { json: { ...mr, skip: true, error: contextResponse.error || 'Failed to get context' } };\n  }\n\n  const mrContext = contextResponse.context;\n  const mrTitle = contextResponse.mrTitle || mr.mr_title;\n  const issueCount = contextResponse.issueCount || 0;\n  const fileCount = contextResponse.fileCount || 0;\n\n  console.log('Got context - issues:', issueCount, 'files:', fileCount, 'context length:', mrContext.length);\n\n  // 2Îã®Í≥Ñ: Ïª®ÌÖçÏä§Ìä∏Î•º Ìè¨Ìï®Ìïú Î¶¨Î∑∞ ÌîÑÎ°¨ÌîÑÌä∏ Íµ¨ÏÑ±\n  const reviewPrompt = `## MR Î¶¨Î∑∞ ÏöîÏ≤≠\n\n**ÌîÑÎ°úÏ†ùÌä∏**: ${gitlabPath}\n**MR**: !${mr.mr_iid} - ${mrTitle}\n**URL**: ${mr.mr_url}\n\n---\n\n${mrContext}\n\n---\n\n## Î¶¨Î∑∞ ÏöîÏ≤≠\n\nÏúÑ MR Î∂ÑÏÑù Í≤∞Í≥ºÏôÄ Ïã§Ï†ú ÏΩîÎìú Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ Î∞îÌÉïÏúºÎ°ú ÏÉÅÏÑ∏Ìïú ÏΩîÎìú Î¶¨Î∑∞Î•º ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.\n\n**Î¶¨Î∑∞ ÌòïÏãù:**\n\n### ÏöîÏïΩ\n(Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ìïú Ï§Ñ ÏöîÏïΩ)\n\n### Ïû•Ï†ê\n- ÏûòÎêú Ï†ê 2-3Í∞ú\n\n### Í∞úÏÑ† ÏÇ¨Ìï≠\n- Í∞úÏÑ†Ïù¥ ÌïÑÏöîÌïú Î∂ÄÎ∂Ñ (Íµ¨Ï≤¥Ï†ÅÏù∏ ÏΩîÎìú ÎùºÏù∏Í≥º Ìï®Íªò)\n- Î≥¥Ïïà, ÏÑ±Îä•, Ïú†ÏßÄÎ≥¥ÏàòÏÑ± Í¥ÄÏ†êÏóêÏÑúÏùò Ï†úÏïà\n\n### ÏßàÎ¨∏\n- Î™ÖÌôïÌïòÏßÄ ÏïäÍ±∞ÎÇò ÌôïÏù∏Ïù¥ ÌïÑÏöîÌïú Î∂ÄÎ∂Ñ\n\n### Ï†ÑÏ≤¥ ÌèâÍ∞Ä\n‚≠ê X/10 - (Ìïú Ï§Ñ ÌèâÍ∞Ä)`;\n\n  // 3Îã®Í≥Ñ: Chat API Ìò∏Ï∂ú (Ïª®ÌÖçÏä§Ìä∏Í∞Ä Ïù¥ÎØ∏ Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏúºÎØÄÎ°ú MR Ïû¨Î∂ÑÏÑù Î∂àÌïÑÏöî)\n  const chatResponse = await this.helpers.httpRequest({\n    method: 'POST',\n    url: apiUrl + '/api/v1/chat/execute',\n    body: {\n      messages: [\n        {\n          role: 'user',\n          content: reviewPrompt\n        }\n      ],\n      projectId: projectId,\n      agentId: 'code-reviewer',\n      skipMrAnalysis: true,  // MR Ïû¨Î∂ÑÏÑù Í±¥ÎÑàÎõ∞Í∏∞ (Ïù¥ÎØ∏ Ïª®ÌÖçÏä§Ìä∏ Ìè¨Ìï®)\n      source: 'scheduled'  // ÏòàÏïΩ Ïã§Ìñâ ÌëúÏãú\n    },\n    json: true,\n    timeout: 600000  // 10Î∂Ñ ÌÉÄÏûÑÏïÑÏõÉ\n  });\n\n  console.log('Chat API response:', chatResponse.success, 'content length:', chatResponse.content?.length || 0);\n\n  if (!chatResponse.success || !chatResponse.content) {\n    console.log('Chat API failed:', chatResponse.error);\n    return { json: { ...mr, skip: true, error: chatResponse.error || 'Chat API failed' } };\n  }\n\n  console.log('AI review completed for MR:', mr.mr_iid);\n\n  return {\n    json: {\n      ...mr,\n      aiReview: chatResponse.content,\n      reviewSuccess: true,\n      agentId: chatResponse.agentId,\n      confidence: chatResponse.confidence,\n      issueCount: issueCount,\n      fileCount: fileCount\n    }\n  };\n} catch (e) {\n  console.log('Error during review:', e.message);\n  return { json: { ...mr, skip: true, error: e.message } };\n}"
      },
      "id": "execute-review",
      "name": "Execute Review",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1840, 100]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.reviewSuccess === true && !$json.skip }}",
              "value2": true
            }
          ]
        }
      },
      "id": "review-success",
      "name": "Review Success?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2040, 100]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Î¶¨Î∑∞ Í≤∞Í≥ºÎ•º GitLab ÏΩîÎ©òÌä∏Î°ú Ìè¨Îß∑\nconst mr = $input.item.json;\nconst analysis = mr.analysis;\nconst aiReview = mr.aiReview;\n\nlet gitlabComment = '## ü§ñ AI Code Review\\n\\n';\n\n// AI Î¶¨Î∑∞Í∞Ä ÏûàÏúºÎ©¥ ÏÇ¨Ïö©\nif (aiReview) {\n  gitlabComment += aiReview;\n  gitlabComment += '\\n\\n';\n} else if (analysis) {\n  // Ìè¥Î∞±: ÏûêÎèô Î∂ÑÏÑù Í≤∞Í≥º ÏÇ¨Ïö©\n  gitlabComment += `### Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ ÏöîÏïΩ\\n${analysis.summary || 'Î∂ÑÏÑù ÏôÑÎ£å'}\\n\\n`;\n  \n  // ÌååÏùº ÌÜµÍ≥Ñ\n  const fa = analysis.fileAnalysis;\n  if (fa) {\n    gitlabComment += `### üìä ÌååÏùº Î≥ÄÍ≤Ω ÌÜµÍ≥Ñ\\n`;\n    gitlabComment += `| Íµ¨Î∂Ñ | Í∞úÏàò |\\n|------|------|\\n`;\n    gitlabComment += `| Ï∂îÍ∞Ä | ${fa.added?.length || 0}Í∞ú (+${fa.totalAdditions || 0} lines) |\\n`;\n    gitlabComment += `| ÏàòÏ†ï | ${fa.modified?.length || 0}Í∞ú |\\n`;\n    gitlabComment += `| ÏÇ≠Ï†ú | ${fa.deleted?.length || 0}Í∞ú (-${fa.totalDeletions || 0} lines) |\\n`;\n    gitlabComment += `| Ïù¥Î¶ÑÎ≥ÄÍ≤Ω | ${fa.renamed?.length || 0}Í∞ú |\\n\\n`;\n  }\n  \n  // ÏûêÎèô Í∞êÏßÄÎêú Ïù¥Ïäà\n  if (analysis.quickIssues && analysis.quickIssues.length > 0) {\n    gitlabComment += '### ‚ö†Ô∏è ÏûêÎèô Í∞êÏßÄÎêú Ïù¥Ïäà\\n';\n    for (const issue of analysis.quickIssues) {\n      const emoji = issue.severity === 'ERROR' ? 'üî¥' : issue.severity === 'WARNING' ? 'üü°' : '‚ÑπÔ∏è';\n      gitlabComment += `${emoji} **[${issue.category}]** ${issue.message}\\n`;\n      if (issue.suggestion) {\n        gitlabComment += `   ‚Üí ${issue.suggestion}\\n`;\n      }\n    }\n    gitlabComment += '\\n';\n  }\n  \n  // Ïö∞ÏÑ† Í≤ÄÌÜ† ÌååÏùº\n  if (analysis.priorityFiles && analysis.priorityFiles.length > 0) {\n    gitlabComment += '### üìã Ïö∞ÏÑ† Í≤ÄÌÜ† ÌååÏùº\\n';\n    for (const file of analysis.priorityFiles.slice(0, 5)) {\n      gitlabComment += `- \\`${file}\\`\\n`;\n    }\n    gitlabComment += '\\n';\n  }\n}\n\ngitlabComment += '---';\n\nreturn {\n  json: {\n    ...mr,\n    gitlabComment: gitlabComment\n  }\n};"
      },
      "id": "format-comment",
      "name": "Format Comment",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2240, 0]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Claude Flow APIÎ•º ÌÜµÌï¥ GitLabÏóê ÏΩîÎ©òÌä∏ ÏûëÏÑ±\nconst mr = $input.item.json;\nconst apiUrl = process.env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080';\n\nconsole.log('Posting comment to MR:', mr.mr_iid);\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: apiUrl + '/api/v1/plugins/gitlab/execute',\n    body: {\n      command: 'mr-comment',\n      args: {\n        project: mr.projectInfo.gitlabPath,\n        mr_id: mr.mr_iid,\n        comment: mr.gitlabComment\n      }\n    },\n    json: true,\n    timeout: 30000\n  });\n\n  if (!response.success) {\n    console.log('Failed to post comment:', response.error);\n    return { json: { ...mr, commentPosted: false, error: response.error } };\n  }\n\n  console.log('Comment posted successfully');\n  return {\n    json: {\n      ...mr,\n      commentPosted: true,\n      noteId: response.data?.id\n    }\n  };\n} catch (e) {\n  console.log('Error posting comment:', e.message);\n  return { json: { ...mr, commentPosted: false, error: e.message } };\n}"
      },
      "id": "post-comment",
      "name": "Post GitLab Comment",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2440, 0]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// MRÏóê ai-review::done ÎùºÎ≤® Ï†ÅÏö© (Claude Flow Plugin API ÏÇ¨Ïö©)\nconst mr = $input.item.json;\n\nif (!mr.commentPosted) {\n  console.log('Comment not posted, skipping label');\n  return { json: mr };\n}\n\nconst apiUrl = process.env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080';\nconst projectPath = mr.projectInfo?.gitlabPath;\n\nif (!projectPath) {\n  console.log('Project path not found');\n  return { json: { ...mr, labelApplied: false } };\n}\n\nconsole.log('Applying label to MR:', mr.mr_iid, 'in', projectPath);\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: apiUrl + '/api/v1/plugins/gitlab/execute',\n    body: {\n      command: 'mr-add-label',\n      args: {\n        project: projectPath,\n        mr_id: mr.mr_iid,\n        label: 'ai-review::done'\n      }\n    },\n    json: true,\n    timeout: 10000\n  });\n\n  if (response.success) {\n    console.log('Label applied successfully');\n    return { json: { ...mr, labelApplied: true } };\n  } else {\n    console.log('Failed to apply label:', response.error);\n    return { json: { ...mr, labelApplied: false, labelError: response.error } };\n  }\n} catch (e) {\n  console.log('Failed to apply label:', e.message);\n  return { json: { ...mr, labelApplied: false, labelError: e.message } };\n}"
      },
      "id": "apply-label",
      "name": "Apply Label",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2640, 0]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Î¶¨Î∑∞ Î†àÏΩîÎìú Ï†ÄÏû•\nconst mr = $input.item.json;\nconst apiUrl = process.env.CLAUDE_FLOW_API_URL || 'http://host.docker.internal:8080';\n\nif (!mr.commentPosted) {\n  console.log('Comment not posted, skipping save');\n  return { json: mr };\n}\n\nconsole.log('Saving review record for MR:', mr.mr_iid);\n\ntry {\n  await this.helpers.httpRequest({\n    method: 'POST',\n    url: apiUrl + '/api/v1/feedback/gitlab-review',\n    body: {\n      projectId: mr.projectInfo?.gitlabPath || mr.projectInfo?.id,\n      mrIid: mr.mr_iid,\n      noteId: mr.noteId || 0,\n      discussionId: null,\n      reviewContent: mr.gitlabComment,\n      mrContext: `${mr.mr_title} - ${mr.mr_description || ''}`\n    },\n    json: true,\n    timeout: 10000\n  });\n  console.log('Review record saved');\n} catch (e) {\n  console.log('Failed to save review record:', e.message);\n}\n\nreturn { json: { ...mr, saved: true } };"
      },
      "id": "save-review",
      "name": "Save Review Record",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2840, 0]
    },
    {
      "parameters": {},
      "id": "noop",
      "name": "No MRs",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1640, 300]
    },
    {
      "parameters": {},
      "id": "noop-projects",
      "name": "No Projects",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [840, 400]
    },
    {
      "parameters": {},
      "id": "review-failed",
      "name": "Review Failed",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [2240, 200]
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [[{ "node": "Get GitLab Projects", "type": "main", "index": 0 }]]
    },
    "Get GitLab Projects": {
      "main": [[{ "node": "Has Projects?", "type": "main", "index": 0 }]]
    },
    "Has Projects?": {
      "main": [
        [{ "node": "Split Projects", "type": "main", "index": 0 }],
        [{ "node": "No Projects", "type": "main", "index": 0 }]
      ]
    },
    "Split Projects": {
      "main": [[{ "node": "Get Project MRs", "type": "main", "index": 0 }]]
    },
    "Get Project MRs": {
      "main": [[{ "node": "Split MRs", "type": "main", "index": 0 }]]
    },
    "Split MRs": {
      "main": [[{ "node": "Should Review?", "type": "main", "index": 0 }]]
    },
    "Should Review?": {
      "main": [
        [{ "node": "Get MR Details", "type": "main", "index": 0 }],
        [{ "node": "No MRs", "type": "main", "index": 0 }]
      ]
    },
    "Get MR Details": {
      "main": [[{ "node": "Execute Review", "type": "main", "index": 0 }]]
    },
    "Execute Review": {
      "main": [[{ "node": "Review Success?", "type": "main", "index": 0 }]]
    },
    "Review Success?": {
      "main": [
        [{ "node": "Format Comment", "type": "main", "index": 0 }],
        [{ "node": "Review Failed", "type": "main", "index": 0 }]
      ]
    },
    "Format Comment": {
      "main": [[{ "node": "Post GitLab Comment", "type": "main", "index": 0 }]]
    },
    "Post GitLab Comment": {
      "main": [[{ "node": "Apply Label", "type": "main", "index": 0 }]]
    },
    "Apply Label": {
      "main": [[{ "node": "Save Review Record", "type": "main", "index": 0 }]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-12-27T06:00:00.000Z",
  "versionId": "2"
}
